---
title: Modelling with categorical predictors
subtitle: "{{< var workshop-title >}}"
description: "[Slide 5]{.tag-workshop}"
format:
  anu-light-revealjs
image: /images/slide5-cover.jpeg
author: Emi Tanaka
date: 2025/02/19
date-format: "D[th] MMMM YYYY"
webr:
  cell-options:
    fig-width: 12
    fig-height: 8
  packages:
    - ggplot2
    - dplyr
    - abd
    - skimr
    - agridat
execute: 
  echo: false
  fig-width: 12
  fig-height: 8
  fig-align: center
---


```{r}
#| include: false
source("setup.R")
```


## {{< fa solid database >}} Revisiting carbon dioxide and growth rate in algae

```{webr}
#| autorun: true
#| include: false
library(tidyverse)
theme_set(theme_bw(base_size = 24))
options(width = 75)
```

::: {.columns}
::: {.column width="50%"}

- Growth rates of 14 unicellular alga _Chlamydomonas_ after 1,000 generations of selection under `High` and `Normal` levels of carbon dioxide were examined.

::: f2

```{webr}
#| autorun: true
#| fig-width: 6
#| fig-height: 6
data(AlgaeCO2, package = "abd")
AlgaeCO2 |> 
  summarise(n = n(),
            mean = mean(growthrate),
            sd = sd(growthrate),
            .by = treatment) 
```

:::

:::

::: {.column width="50%" .f2}

```{webr}
#| autorun: true
#| fig-width: 6
#| fig-height: 6
data(AlgaeCO2, package = "abd")
ggplot(AlgaeCO2, aes(treatment, growthrate)) + 
  geom_point(size = 4)
```

:::
:::





::: aside 

Collins, S. and G. Bell. 2004. Phenotypic consequences of 1,000 generations of selection at elevated CO<sub>2</sub> in a green alga. Nature 431: 566-569.
:::

## One-way ANOVA model 

- A **one-way ANOVA model** is just a linear model where the response variable is modelled as a function of a single categorical explanatory variable.

```{webr}
coef(lm(growthrate ~ treatment, data = AlgaeCO2))
```

- For $i=1, \ldots, t$ and $j = 1, \ldots, n_i$, 

$$y_{ij} = \beta_0 + \alpha_i + \epsilon_{ij}, \qquad \epsilon_{ij}\sim NID(0, \sigma^2).$$

- In this model, $\alpha_i$ is the effect of the $i$-th level of the factor `treatment`.

## Dummy variables

- When we fit a model with categorical explanatory variables, categorical variables are converted into a numerical representations, e.g. using a set of dummy variables.
- A **dummy variable** is a binary representation of one level of a categorical variable where 1 indicates the presence of that level and 0 indicating the absence of that level.

::: f2

```{webr}
model.matrix(~treatment, data = AlgaeCO2)
```

:::

## Constraints and contrasts 

- For $i=1, \ldots, t$ and $j = 1, \ldots, n_i$, 

$$y_{ij} = \beta_0 + \alpha_i + \epsilon_{ij}, \qquad \epsilon_{ij}\sim NID(0, \sigma^2).$$

```{webr}
coef(lm(growthrate ~ treatment, data = AlgaeCO2))
```

- So far the coefficient estimate for $\alpha_1$ or it's associated dummy variable is not shown. 
- By default, `lm()` uses the **treatment constraint**, where the first level of the factor is the reference level (i.e. $\alpha_1 = 0$).
- The constraint is necessary to **make the model identifiable**.




## One-way ANOVA model vs two-sample t-test

- To test if the growth rates of algae under `high CO2` and `normal CO2` levels of carbon dioxide are different, we can use a two-sample t-test:

::: f2

```{webr}
highCO2 <- with(AlgaeCO2, growthrate[treatment == "high CO2"])
normalCO2 <- with(AlgaeCO2, growthrate[treatment == "normal CO2"])
t.test(highCO2, normalCO2, var.equal = TRUE)$p.value
```

:::

. . . 

- Alternatively, we can fit a model with the `treatment` as a factor and test if the effect of `treatment` is significant:


::: f2

```{webr}
broom::tidy(lm(growthrate ~ treatment, data = AlgaeCO2))
```

:::

. . . 

- The p-value for the `treatment` factor is the same as the p-value for the above two-sample t-test!



## Categorical or numerical variable?

- Sometimes it is unclear as to whether a particular explanatory variable should be regarded as a **factor** (categorical explanatory variable) or a **numerical covariate**.




## <i class="fas fa-database"></i> Longevity of fruitflies {background-color="#F5EDDE"}

**Aim**: Study longevity of fruitflies depending on sexual activity and thorax length

::: {.columns .f2}

::: {.column width="55%"}

```{r fig-fruitfly, dev.args=list(bg = "transparent")}
#| code-fold: true
library(tidyverse)
gfly <- faraway::fruitfly |> 
  mutate(activity = factor(activity, levels = c("isolated", "low", "high", "one", "many"))) |> 
  ggplot(aes(x = thorax, y = longevity, color = activity)) + 
  geom_point(data = ~select(., -activity), color = "lightgrey") +
  geom_point(size = 4) + 
  facet_wrap(~activity, labeller = label_both) +
  guides(color = "none") + 
  colorspace::scale_color_discrete_qualitative()

gfly
```

```{r}
#| echo: false
cols <- colorspace::qualitative_hcl(n = 5)
```


:::

::: {.f2 .column width="45%"}

- 125 fruitflies were divided randomly into 5 groups of 25 each. 
- The response was the longevity of the fruitfly in days. 
- One group was kept solitary (["isolated"]{style='color:`r cols[1]`'}).  
- Another was kept individually with a virgin female each day (["low"]{style='color:`r cols[2]`'}).
- Another group was given 8 virgin females per day (["high"]{style='color:`r cols[3]`'}). 
- As an additional control the fourth and fifth groups were kept with one (["one"]{style='color:`r cols[4]`'}) or eight (["many"]{style='color:`r cols[5]`'}) pregnant females per day. 
- Pregnant fruitflies will not mate. 
- The thorax length of each male was measured as this was known to affect longevity. 
- One observation in the many group has been lost.

:::

:::


## Linear model 1

`lm(longevity ~ thorax + activity + thorax:activity)`

$\texttt{longevity}_i = \beta_0 + \beta_1\texttt{thorax}_i + \beta_{2,T(i)} + \beta_{3,T(i)}\texttt{thorax}_i + \epsilon_i$

<details class="f2">

::: {.columns .f2}

::: {.column width="50%"}

where 

- $\beta_0$ is the overall intercept, 
- $\beta_1$ is the effect of thorax length on longevity,
- $\beta_{2,T(i)}$ is the effect of activity on longevity,
- $T(i)$ maps to the activity type of the $i$-th observation,
- $\beta_{3,T(i)}$ is the interaction effect between thorax length and activity type, and
- $\epsilon_i$ is the error term.

:::

::: {.column width="50%"}

Note that:

- We assume $\epsilon_i  \stackrel{iid}{\sim} N(0, \sigma^2)$.
- We use the constraints: $\beta_{2,1} = 0$ and $\beta_{3,1} = 0$.
- $\beta_0 + \beta_{2,k}$ is the intercept for the $k$-th activity type.
- $\beta_1 + \beta_{3,k}$ is the slope for the $k$-th activity type.

:::

:::

</details>


::: {.columns .f2}

::: {.column width="55%"}

```{r fig-fruitfly2}
#| code-fold: true
gfly + geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 2)
```

:::

::: {.column width="45%"}

```{r}
#| code-fold: true
#| fig-width: 10
flyfit1 <- lm(longevity ~ thorax + activity + thorax:activity, data = faraway::fruitfly) |> 
  broom::augment() |> 
  mutate(activity = factor(activity, levels = c("isolated", "low", "high", "one", "many"))) 
gres <- flyfit1 |> 
  ggplot(aes(.fitted, .resid, color = activity)) + 
  geom_point(data = ~select(., -activity), color = "lightgrey") + 
  geom_point(size = 4) +
  #facet_wrap(~activity, labeller = label_both) +
  guides(color = "none") +
  geom_hline(yintercept = 0, color = "black", linetype = 2) +
  colorspace::scale_color_discrete_qualitative() +
  labs(x = "Fitted values", y = "Residual", title = "Residual vs fitted values plot")

gres

```


:::

:::

## Linear model 2

`lm(log10(longevity) ~ thorax + activity + thorax:activity)`

$\log_{10}(\texttt{longevity}_i) = \beta_0 + \beta_1\texttt{thorax}_i + \beta_{2,T(i)} + \beta_{3,T(i)}\texttt{thorax}_i + \epsilon_i$


::: {.columns .f2}

::: {.column width="55%"}

```{r fig-fruitfly3}
#| code-fold: true
gfly + geom_smooth(method = "lm", se = FALSE, color = "black", linewidth = 2) +
  scale_y_log10()
```

:::

::: {.f2 .column width="45%"}


```{r}
#| code-fold: true
#| fig-width: 10
flyfit2 <- lm(log10(longevity) ~ thorax + activity + thorax:activity, data = faraway::fruitfly) |> 
  broom::augment() |> 
  mutate(.fitted = 10^.fitted) |> 
  mutate(activity = factor(activity, levels = c("isolated", "low", "high", "one", "many"))) 

gres %+% flyfit2
```

:::

:::





## Linear model 3

`lm(log10(longevity) ~ thorax + activity)`

$\log_{10}(\texttt{longevity}_i) = \beta_0 + \beta_1\texttt{thorax}_i + \beta_{2,T(i)} + \epsilon_i$

<details class="f2">
```{r}
fit1 <- lm(log10(longevity) ~ thorax + activity, data = faraway::fruitfly)
fit2 <- lm(log10(longevity) ~ thorax + activity + thorax:activity, data = faraway::fruitfly)
anova(fit1, fit2)
```
</details>

::: {.columns .f2}

::: {.column width="55%"}

```{r fig-fruitfly4}
#| code-fold: true
fit <- lm(log10(longevity) ~ -1 + thorax + activity, data = faraway::fruitfly)
est <- tibble(slope = coef(fit)[1], 
              intercept = coef(fit)[-1],
              activity = str_remove(names(coef(fit)[-1]), "^activity")) |> 
mutate(activity = factor(activity, levels = c("isolated", "low", "high", "one", "many"))) 
gfly + geom_abline(aes(slope = slope, intercept = intercept), color = "black", linewidth = 2, data = est) + scale_y_log10()
```

:::

::: {.f2 .column width="45%"}

```{r}
#| code-fold: true
#| fig-width: 10


gres %+% (broom::augment(fit) |> 
  mutate(activity = factor(activity, levels = c("isolated", "low", "high", "one", "many"))))

```

:::

:::



## Multiple linear regression

For $i = 1, ..., n$, the linear regression model is given by 

$$y_i = \beta_0 + \beta_1x_{i1} + \beta_2x_{i2} + \cdots + \beta_kx_{ik} + \epsilon_i=  \sum_{j=0}^{k}\beta_jx_{ij} + \epsilon_i$$



where

  - $y_i$ is the response variable,
  - $x_{ij}$ is the $j$-th predictor variable and $x_{0j} = 1$ for all $j$,
  - $\beta_j$ is the coefficient for the $j$-th predictor variable,
  - $\epsilon_i$ is the error term, and
  - we assume that [$\epsilon_i \stackrel{iid}{\sim} N(0, \sigma^2)$]{.anu-gold}.



## Summary

- Dummy variables
- Constraints and contrasts 
- Interpretation for categorical predictors



